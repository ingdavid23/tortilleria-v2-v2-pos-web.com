<!doctype html>
<html lang="es" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gesti√≥n - Escuela de Ingl√©s</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>

  <style>
    * { font-family: 'Poppins', sans-serif; }
    .sidebar-item { transition: all 0.2s ease; }
    .sidebar-item:hover { transform: translateX(4px); }
    .card-hover { transition: all 0.3s ease; }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    .fade-in { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .btn-primary { background: linear-gradient(135deg, #1B396A 0%, #005A9C 100%); }
    .btn-primary:hover { background: linear-gradient(135deg, #132A50 0%, #00457A 100%); }
    .gradient-bg { background: linear-gradient(135deg, #1B396A 0%, #005A9C 100%); }
    .toast { animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(100%); opacity: 0; } }
  </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="h-full bg-gray-100"><div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div><div id="login-screen" class="h-full flex items-center justify-center gradient-bg">
   <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4 fade-in">
    <div class="text-center mb-8">
     <div class="w-20 h-20 mx-auto mb-4 rounded-full gradient-bg flex items-center justify-center">
      <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
      </svg>
     </div>
     <h1 id="login-title" class="text-2xl font-bold text-gray-800">Centro de Idiomas</h1>
     <p class="text-gray-500 mt-2">Sistema de Gesti√≥n Escolar en la Nube</p>
    </div>
    <form id="login-form" class="space-y-6">
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Usuario / Nombre / No. Control</label> <input type="text" id="login-user" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-800 focus:border-transparent transition" placeholder="Ingresa tu usuario">
     </div>
     <div><label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a</label> <input type="password" id="login-pass" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-800 focus:border-transparent transition" placeholder="Ingresa tu contrase√±a">
     </div>
     <div id="login-error" class="hidden text-red-500 text-sm text-center bg-red-50 p-3 rounded-lg"></div>
     <button type="submit" id="btn-login" class="w-full btn-primary text-white py-3 rounded-lg font-semibold hover:shadow-lg transition"> Iniciar Sesi√≥n </button>
    </form>
    
    <div class="mt-6 text-center text-xs text-gray-400 border-t pt-4">
      <p><strong>Admin:</strong> admin / admin</p>
      <p><strong>Maestro:</strong> Nombre Completo / Contrase√±a asignada</p>
      <p><strong>Alumno:</strong> No. Control / Contrase√±a asignada</p>
    </div>

   </div>
  </div><div id="dashboard" class="hidden h-full flex w-full relative overflow-hidden">
    
    <div class="md:hidden gradient-bg text-white flex items-center justify-between p-4 fixed top-0 w-full z-20 shadow-md">
      <div class="font-bold text-lg truncate flex items-center gap-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
        Centro de Idiomas
      </div>
      <button onclick="toggleMobileMenu()" class="p-1 focus:outline-none rounded hover:bg-white/20 transition">
        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
      </button>
    </div>

    <div id="mobile-overlay" onclick="toggleMobileMenu()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden transition-opacity opacity-0"></div>

    <aside id="sidebar" class="w-64 gradient-bg text-white flex flex-col fixed md:relative z-40 h-full transform -translate-x-full md:translate-x-0 transition-transform duration-300 shadow-2xl md:shadow-none">
    <div class="p-6 border-b border-white/20 mt-14 md:mt-0"> <h2 id="sidebar-title" class="text-xl font-bold truncate">Centro de Idiomas</h2>
     <p id="sidebar-role" class="text-blue-200 text-xs font-semibold mt-1 tracking-wider uppercase">ADMINISTRADOR</p>
    </div>
    <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
      <button id="nav-alumnos" onclick="showSection('alumnos')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-left" data-section="alumnos">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg> Registrar Alumnos </button> 
      
      <button id="nav-maestros" onclick="showSection('maestros')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-left" data-section="maestros">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg> Registrar Maestros </button> 
      
      <button id="nav-grupos" onclick="showSection('grupos')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-left" data-section="grupos">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg> Gestionar Grupos </button> 
      
      <button id="nav-listas" onclick="showSection('listas')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-left" data-section="listas">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> Generar Listas </button> 
      
      <button id="nav-calificaciones" onclick="showSection('calificaciones')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-left" data-section="calificaciones">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg> Calificaciones </button>
      
      <button id="nav-historial" onclick="showSection('historial')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-left" data-section="historial">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> Historial </button>

      <button id="nav-mis-calificaciones" onclick="showSection('mis-calificaciones')" class="sidebar-item w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-left hidden" data-section="mis-calificaciones">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg> Mi Historial </button>

    </nav>
    <div class="p-4 border-t border-white/20"><button onclick="logout()" class="w-full flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/10 text-left">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
      </svg> Cerrar Sesi√≥n </button>
    </div>
   </aside>
   
   <main class="flex-1 overflow-auto p-4 md:p-8 pt-20 md:pt-8 w-full bg-gray-100">
       
    <div id="stats-header" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-6 mb-8">
     <div class="bg-white rounded-xl p-6 shadow-sm card-hover">
      <div class="flex items-center gap-4">
       <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center">
        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
        </svg>
       </div>
       <div>
        <p class="text-gray-500 text-sm">Mis Alumnos</p>
        <p id="stat-alumnos" class="text-2xl font-bold text-gray-800">0</p>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-xl p-6 shadow-sm card-hover" id="stat-card-maestros">
      <div class="flex items-center gap-4">
       <div class="w-12 h-12 rounded-lg bg-indigo-100 flex items-center justify-center">
        <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
        </svg>
       </div>
       <div>
        <p class="text-gray-500 text-sm">Total Maestros</p>
        <p id="stat-maestros" class="text-2xl font-bold text-gray-800">0</p>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-xl p-6 shadow-sm card-hover">
      <div class="flex items-center gap-4">
       <div class="w-12 h-12 rounded-lg bg-green-100 flex items-center justify-center">
        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
       </div>
       <div>
        <p class="text-gray-500 text-sm">Mis Grupos Activos</p>
        <p id="stat-grupos" class="text-2xl font-bold text-gray-800">0</p>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-xl p-6 shadow-sm card-hover">
      <div class="flex items-center gap-4">
       <div class="w-12 h-12 rounded-lg bg-orange-100 flex items-center justify-center">
        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
         <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
        </svg>
       </div>
       <div>
        <p class="text-gray-500 text-sm">M√≥dulos</p>
        <p id="stat-modulos" class="text-2xl font-bold text-gray-800">5</p>
       </div>
      </div>
     </div>
    </div>

    <section id="section-mis-calificaciones" class="hidden fade-in">
     <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6">
      <div class="flex items-center gap-4 mb-6 pb-6 border-b border-gray-100">
        <div class="w-12 h-12 md:w-16 md:h-16 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 flex-shrink-0">
          <svg class="w-6 h-6 md:w-8 md:h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l9-5-9-5-9 5 9 5z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"></path></svg>
        </div>
        <div>
          <h3 id="alumno-perfil-nombre" class="text-xl md:text-2xl font-bold text-gray-800">Nombre del Alumno</h3>
          <p id="alumno-perfil-info" class="text-sm md:text-base text-gray-500">No. Control ‚Ä¢ Carrera</p>
        </div>
      </div>
      
      <h4 class="font-semibold text-gray-800 mb-4">Historial de Calificaciones</h4>
      <div class="overflow-x-auto">
       <table class="w-full whitespace-nowrap">
        <thead>
         <tr class="border-b border-gray-200 bg-gray-50">
          <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Grupo</th>
          <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">M√≥dulo</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">P1</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">P2</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">P3</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">P4</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">Promedio</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">Estado</th>
         </tr>
        </thead>
        <tbody id="tabla-mis-calificaciones">
         <tr>
          <td colspan="8" class="py-8 text-center text-gray-400">Cargando calificaciones...</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </section>

    <section id="section-alumnos" class="fade-in">
     <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6">
      <h3 id="titulo-form-alumno" class="text-lg md:text-xl font-bold text-gray-800 mb-6 flex items-center gap-3">
       <svg class="w-6 h-6 text-blue-800" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
       </svg> Registrar Nuevo Alumno</h3>
      <form id="form-alumno" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label> <input type="text" id="alumno-nombre" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nombre completo del alumno">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">N√∫mero de Control *</label> <input type="text" id="alumno-control" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: 20230001">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Carrera *</label> <select id="alumno-carrera" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Selecciona una carrera</option> <option value="Ingenier√≠a en Sistemas">Ingenier√≠a en Sistemas</option> <option value="Ingenier√≠a Industrial">Ingenier√≠a Industrial</option> <option value="Ingenier√≠a Civil">Ingenier√≠a Civil</option> <option value="Ingenier√≠a Mec√°nica">Ingenier√≠a Mec√°nica</option> <option value="Ingenier√≠a Electr√≥nica">Ingenier√≠a Electr√≥nica</option> <option value="Administraci√≥n">Administraci√≥n</option> <option value="Contadur√≠a">Contadur√≠a</option> <option value="Arquitectura">Arquitectura</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Modalidad *</label> <select id="alumno-modalidad" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Selecciona modalidad</option> <option value="Escolarizado">Escolarizado</option> <option value="Mixto">Mixto</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono (WhatsApp) *</label> <input type="tel" id="alumno-telefono" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Ej: 9631234567 (10 d√≠gitos)">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">M√≥dulo de Ingl√©s *</label> <select id="alumno-modulo" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Selecciona m√≥dulo</option> <option value="1-2">M√≥dulo 1-2</option> <option value="3-4">M√≥dulo 3-4</option> <option value="5-6">M√≥dulo 5-6</option> <option value="7-8">M√≥dulo 7-8</option> <option value="9-10">M√≥dulo 9-10</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a de Acceso *</label> <input type="text" id="alumno-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Contrase√±a para el portal del alumno">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Asignar a Grupo Activo *</label> <select id="alumno-grupo" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Selecciona un grupo</option> </select>
       </div>
       <div class="md:col-span-2 flex flex-col sm:flex-row gap-4">
        <button type="submit" id="btn-registrar-alumno" class="btn-primary text-white w-full sm:w-auto px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition flex justify-center items-center gap-2">
         <svg id="icono-btn-alumno" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
         </svg> <span id="texto-btn-alumno">Registrar Alumno</span>
        </button>
        <button type="button" id="btn-cancelar-edicion-alumno" onclick="cancelarEdicionAlumno()" class="hidden w-full sm:w-auto bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
         Cancelar Edici√≥n
        </button>
       </div>
      </form>
     </div><div class="bg-white rounded-xl shadow-sm p-4 md:p-6">
      <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-4 md:mb-6">Alumnos Registrados / Reinscripciones</h3>
      <div class="overflow-x-auto">
       <table class="w-full whitespace-nowrap">
        <thead>
         <tr class="border-b border-gray-200">
          <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Nombre</th>
          <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">No. Control</th>
          <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Carrera</th>
          <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">M√≥dulo</th>
          <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Grupo / Estado</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">Acciones</th>
         </tr>
        </thead>
        <tbody id="tabla-alumnos">
         <tr>
          <td colspan="6" class="py-8 text-center text-gray-400">No hay alumnos registrados</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </section><section id="section-maestros" class="hidden fade-in">
     <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6">
      <h3 id="titulo-form-maestro" class="text-lg md:text-xl font-bold text-gray-800 mb-6 flex items-center gap-3">
       <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path>
       </svg> Registrar Nuevo Maestro</h3>
      <form id="form-maestro" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Nombre Completo *</label> <input type="text" id="maestro-nombre" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Nombre completo del maestro">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Especialidad/Nivel *</label> <select id="maestro-especialidad" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"> <option value="">Selecciona especialidad</option> <option value="B√°sico (1-4)">B√°sico (M√≥dulos 1-4)</option> <option value="Intermedio (5-8)">Intermedio (M√≥dulos 5-8)</option> <option value="Avanzado (9-10)">Avanzado (M√≥dulos 9-10)</option> <option value="Todos los niveles">Todos los niveles</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Contrase√±a de Acceso *</label> <input type="text" id="maestro-password" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Asigna una contrase√±a (ej. pass123)">
       </div>
       <div class="md:col-span-2 flex flex-col sm:flex-row gap-4">
         <button type="submit" id="btn-registrar-maestro" class="bg-blue-600 w-full sm:w-auto justify-center hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition flex items-center gap-2">
           <svg id="icono-btn-maestro" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
           </svg> <span id="texto-btn-maestro">Registrar Maestro</span>
         </button>
         <button type="button" id="btn-cancelar-edicion-maestro" onclick="cancelarEdicionMaestro()" class="hidden w-full sm:w-auto bg-gray-300 hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition">
           Cancelar Edici√≥n
         </button>
       </div>
      </form>
     </div><div class="bg-white rounded-xl shadow-sm p-4 md:p-6">
      <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-6">Maestros Registrados</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="lista-maestros">
       <div class="text-center text-gray-400 py-8 col-span-full">
        No hay maestros registrados
       </div>
      </div>
     </div>
    </section><section id="section-grupos" class="hidden fade-in">
     <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6">
      <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-6 flex items-center gap-3">
       <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
       </svg> Crear Nuevo Grupo</h3>
      <form id="form-grupo" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Nombre del Grupo *</label> <input type="text" id="grupo-nombre" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Ej: Grupo A">
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">M√≥dulo *</label> <select id="grupo-modulo" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"> <option value="">Selecciona m√≥dulo</option> <option value="1-2">M√≥dulo 1-2</option> <option value="3-4">M√≥dulo 3-4</option> <option value="5-6">M√≥dulo 5-6</option> <option value="7-8">M√≥dulo 7-8</option> <option value="9-10">M√≥dulo 9-10</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Maestro Asignado</label> <select id="grupo-maestro" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"> <option value="">Sin asignar</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Periodo Escolar *</label> <input type="text" id="grupo-periodo" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="Ej: Ene-Jun 2026">
       </div>
       <div class="md:col-span-2"><button type="submit" id="btn-crear-grupo" class="bg-green-600 w-full sm:w-auto justify-center hover:bg-green-700 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition flex items-center gap-2">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
         </svg> Crear Grupo </button>
       </div>
      </form>
     </div><div class="bg-white rounded-xl shadow-sm p-4 md:p-6">
      <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-6">Grupos Activos</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="lista-grupos">
       <div class="text-center text-gray-400 py-8 col-span-full">
        No hay grupos creados
       </div>
      </div>
     </div>
    </section><section id="section-listas" class="hidden fade-in">
     <div class="bg-white rounded-xl shadow-sm p-4 md:p-6">
      <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-6 flex items-center gap-3">
       <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
       </svg> Generar Listas de Alumnos</h3>
      <div class="mb-6"><label class="block text-sm font-medium text-gray-700 mb-2">Selecciona un Grupo Activo</label> <select id="lista-grupo-select" class="w-full md:w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"> <option value="">Selecciona un grupo</option> </select>
      </div>
      <div id="lista-preview" class="hidden">
       <div class="border border-gray-200 rounded-lg p-4 md:p-6 mb-4 bg-gray-50">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
         <div>
          <h4 id="lista-grupo-titulo" class="text-lg font-bold text-gray-800"></h4>
          <p id="lista-grupo-info" class="text-sm text-gray-500"></p>
         </div>
         <div class="flex gap-2 w-full sm:w-auto">
           <button onclick="descargarListaExcel()" class="flex-1 sm:flex-none justify-center bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 text-sm shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> 
            Excel
           </button>
           <button onclick="descargarListaPDF()" class="flex-1 sm:flex-none justify-center bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 text-sm shadow-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> 
            PDF
           </button>
         </div>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full whitespace-nowrap">
           <thead>
            <tr class="border-b border-gray-300">
             <th class="text-left py-2 px-3 text-sm font-semibold text-gray-600">#</th>
             <th class="text-left py-2 px-3 text-sm font-semibold text-gray-600">Nombre</th>
             <th class="text-left py-2 px-3 text-sm font-semibold text-gray-600">No. Control</th>
             <th class="text-left py-2 px-3 text-sm font-semibold text-gray-600">Carrera</th>
             <th class="text-left py-2 px-3 text-sm font-semibold text-gray-600">Modalidad</th>
            </tr>
           </thead>
           <tbody id="lista-alumnos-body">
           </tbody>
          </table>
        </div>
       </div>
      </div>
      <div id="lista-empty" class="text-center text-gray-400 py-8">
       Selecciona un grupo para ver la lista de alumnos
      </div>
     </div>
    </section><section id="section-calificaciones" class="hidden fade-in">
     <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 md:gap-6 mb-8">
      <div class="bg-white rounded-xl p-6 shadow-sm card-hover">
       <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-lg bg-green-100 flex items-center justify-center">
         <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
         </svg>
        </div>
        <div>
         <p class="text-gray-500 text-sm">√çndice de Aprobaci√≥n</p>
         <p id="stat-aprobacion" class="text-2xl font-bold text-green-600">0%</p>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-sm card-hover">
       <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-lg bg-red-100 flex items-center justify-center">
         <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l-2-2m0 0l-2-2m2 2l2-2m-2 2l-2 2m8-8l2 2m0 0l2 2m-2-2l-2-2m2 2l2-2"></path>
         </svg>
        </div>
        <div>
         <p class="text-gray-500 text-sm">√çndice de Reprobaci√≥n</p>
         <p id="stat-reprobacion" class="text-2xl font-bold text-red-600">0%</p>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-xl p-6 shadow-sm card-hover">
       <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-lg bg-blue-100 flex items-center justify-center">
         <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
         </svg>
        </div>
        <div>
         <p class="text-gray-500 text-sm">Promedio General del Grupo</p>
         <p id="stat-promedio-grupo" class="text-2xl font-bold text-blue-600">0.0</p>
        </div>
       </div>
      </div>
     </div><div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6" id="card-captura-calificaciones">
      <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-6 flex items-center gap-3">
       <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
       </svg> Capturar Calificaciones</h3>
      <form id="form-calificaciones" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Selecciona un Grupo Activo *</label> <select id="calif-grupo" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"> <option value="">Selecciona un grupo</option> </select>
       </div>
       <div><label class="block text-sm font-medium text-gray-700 mb-2">Selecciona un Alumno *</label> <select id="calif-alumno" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"> <option value="">Primero selecciona un grupo</option> </select>
       </div>
       <div class="bg-indigo-50 rounded-lg p-4 md:col-span-2 border border-indigo-200">
        <h4 class="font-semibold text-indigo-900 mb-3">Ingresa los 4 Parciales</h4>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
         <div><label class="block text-xs font-medium text-gray-700 mb-1">Parcial 1 *</label> <input type="number" id="calif-parcial1" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-center" placeholder="0-100">
         </div>
         <div><label class="block text-xs font-medium text-gray-700 mb-1">Parcial 2 *</label> <input type="number" id="calif-parcial2" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-center" placeholder="0-100">
         </div>
         <div><label class="block text-xs font-medium text-gray-700 mb-1">Parcial 3 *</label> <input type="number" id="calif-parcial3" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-center" placeholder="0-100">
         </div>
         <div><label class="block text-xs font-medium text-gray-700 mb-1">Parcial 4 *</label> <input type="number" id="calif-parcial4" min="0" max="100" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-center" placeholder="0-100">
         </div>
        </div>
       </div>
       <div class="md:col-span-2 flex flex-col sm:flex-row gap-4">
         <button type="submit" id="btn-guardar-calificacion" class="bg-indigo-600 w-full sm:w-auto justify-center hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition flex items-center gap-2">
         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
         </svg> Guardar </button> 
         <button type="button" onclick="limpiarFormularioCalificaciones()" class="bg-gray-300 w-full sm:w-auto hover:bg-gray-400 text-gray-800 px-6 py-3 rounded-lg font-semibold transition"> Limpiar </button>
       </div>
      </form>
     </div><div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6">
      <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-6">Calificaciones por Grupo Activo</h3>
      <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Selecciona un Grupo para Ver Calificaciones</label> <select id="calif-grupo-view" class="w-full md:w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"> <option value="">Selecciona un grupo</option> </select>
      </div>
      <div class="overflow-x-auto">
       <table class="w-full whitespace-nowrap">
        <thead>
         <tr class="border-b border-gray-200 bg-gray-50">
          <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Alumno</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">P1</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">P2</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">P3</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">P4</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">Promedio</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">Estado</th>
          <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600" id="th-acciones-calif">Acciones</th>
         </tr>
        </thead>
        <tbody id="tabla-calificaciones">
         <tr>
          <td colspan="8" class="py-8 text-center text-gray-400">Selecciona un grupo para ver las calificaciones</td>
         </tr>
        </tbody>
       </table>
      </div>
     </div><div class="bg-white rounded-xl shadow-sm p-4 md:p-6">
      <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-6">Generar Boleta Oficial</h3>
      <div class="mb-4"><label class="block text-sm font-medium text-gray-700 mb-2">Selecciona un Grupo</label> <select id="boleta-grupo-select" class="w-full md:w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"> <option value="">Selecciona un grupo</option> </select>
      </div>
      <button onclick="descargarBoletaPDFReal('activo')" class="bg-red-600 w-full sm:w-auto justify-center hover:bg-red-700 text-white px-6 py-3 rounded-lg font-semibold hover:shadow-lg transition flex items-center gap-2">
       <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
       </svg> Descargar PDF </button>
     </div>
    </section>

    <section id="section-historial" class="hidden fade-in">
     <div class="bg-white rounded-xl shadow-sm p-4 md:p-6 mb-6">
      <h3 class="text-lg md:text-xl font-bold text-gray-800 mb-6 flex items-center gap-3">
       <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
       </svg> Historial de Grupos Cerrados</h3>
      <div class="mb-6">
       <label class="block text-sm font-medium text-gray-700 mb-2">Selecciona un Grupo Cerrado</label>
       <select id="historial-grupo-select" class="w-full md:w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-gray-500 focus:border-transparent">
        <option value="">Selecciona un grupo</option>
       </select>
      </div>
      
      <div id="historial-content" class="hidden">
       <div class="border border-gray-200 rounded-lg p-4 md:p-6 mb-4 bg-gray-50">
        
        <div class="mb-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
         <div>
          <h4 id="historial-grupo-titulo" class="text-lg font-bold text-gray-800"></h4>
          <p id="historial-grupo-info" class="text-sm text-gray-500"></p>
         </div>
         <div class="flex gap-2 w-full sm:w-auto">
           <button onclick="descargarBoletaPDFReal('historial')" class="flex-1 sm:flex-none justify-center bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg> 
            PDF
           </button>
           <button id="btn-reabrir-grupo" class="hidden flex-1 sm:flex-none justify-center bg-green-100 text-green-700 hover:bg-green-200 px-4 py-2 rounded-lg font-semibold transition flex items-center gap-2 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> 
            Reabrir
           </button>
         </div>
        </div>

        <div class="overflow-x-auto">
         <table class="w-full whitespace-nowrap">
          <thead>
           <tr class="border-b border-gray-300 bg-gray-100">
            <th class="text-left py-3 px-4 text-sm font-semibold text-gray-600">Nombre del Alumno</th>
            <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">P1</th>
            <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">P2</th>
            <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">P3</th>
            <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">P4</th>
            <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">Promedio</th>
            <th class="text-center py-3 px-4 text-sm font-semibold text-gray-600">Estado</th>
           </tr>
          </thead>
          <tbody id="historial-alumnos-body">
          </tbody>
         </table>
        </div>
       </div>
      </div>
      <div id="historial-empty" class="text-center text-gray-400 py-8">
       Selecciona un grupo cerrado para ver su historial
      </div>
     </div>
    </section>

   </main>
  </div>
  
  <div id="confirm-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
   <div class="bg-white rounded-xl p-6 max-w-sm md:max-w-md w-full mx-4 fade-in">
    <h3 id="confirm-modal-title" class="text-lg font-bold text-gray-800 mb-2">Confirmar Acci√≥n</h3>
    <p id="confirm-modal-text" class="text-gray-600 mb-6">¬øEst√°s seguro?</p>
    <div class="flex flex-col sm:flex-row gap-4 justify-end">
     <button onclick="closeConfirmModal()" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition w-full sm:w-auto">Cancelar</button> 
     <button id="confirm-action-btn" class="px-4 py-2 text-white rounded-lg transition w-full sm:w-auto">Confirmar</button>
    </div>
   </div>
  </div>

  <div id="whatsapp-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
   <div class="bg-white rounded-xl p-6 max-w-sm md:max-w-md w-full mx-4 fade-in">
    <div class="flex items-center gap-3 mb-4">
      <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600 flex-shrink-0">
        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
      </div>
      <h3 class="text-lg font-bold text-gray-800">Enviar Mensaje</h3>
    </div>
    <p class="text-sm text-gray-600 mb-4">Selecciona una plantilla r√°pida para <strong id="wa-alumno-nombre" class="text-gray-800"></strong>:</p>
    <div class="space-y-2">
     <button onclick="sendWA('saludo')" class="w-full text-left px-4 py-3 border border-gray-200 rounded-lg hover:bg-green-50 hover:border-green-300 transition text-sm text-gray-700 truncate">üëã Saludo General</button>
     <button onclick="sendWA('pago')" class="w-full text-left px-4 py-3 border border-gray-200 rounded-lg hover:bg-green-50 hover:border-green-300 transition text-sm text-gray-700 truncate">üí∞ Recordatorio de Pago</button>
     <button onclick="sendWA('aviso')" class="w-full text-left px-4 py-3 border border-gray-200 rounded-lg hover:bg-green-50 hover:border-green-300 transition text-sm text-gray-700 truncate">üì¢ Aviso Importante</button>
     <button onclick="sendWA('calificaciones')" class="w-full text-left px-4 py-3 border border-gray-200 rounded-lg hover:bg-green-50 hover:border-green-300 transition text-sm text-gray-700 truncate">üéì Boleta de Calificaciones</button>
    </div>
    <div class="mt-6 flex justify-end">
     <button onclick="closeWAModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium w-full sm:w-auto">Cancelar</button>
    </div>
   </div>
  </div>

  <script>
    // ==========================================
    // L√ìGICA DE MEN√ö M√ìVIL
    // ==========================================
    function toggleMobileMenu() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('mobile-overlay');
      
      const isClosed = sidebar.classList.contains('-translate-x-full');
      
      if (isClosed) {
        sidebar.classList.remove('-translate-x-full');
        overlay.classList.remove('hidden');
        setTimeout(() => overlay.classList.remove('opacity-0'), 10);
      } else {
        sidebar.classList.add('-translate-x-full');
        overlay.classList.add('opacity-0');
        setTimeout(() => overlay.classList.add('hidden'), 300);
      }
    }

    // ==========================================
    // CONFIGURACI√ìN DE FIREBASE
    // ==========================================
    const firebaseConfig = {
      apiKey: "AIzaSyBnojo8egePQ3Inhb-86JfKPdkBLfaLQcM",
      authDomain: "inglestec-b1613.firebaseapp.com",
      projectId: "inglestec-b1613",
      storageBucket: "inglestec-b1613.firebasestorage.app",
      messagingSenderId: "488457752288",
      appId: "1:488457752288:web:e0a4ecd272b2345a904a85",
      measurementId: "G-GL5HF8D3GW"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const COLOR_AZUL_TECNM = [27, 57, 106]; 
    const nextModuleMap = {
      '1-2': '3-4',
      '3-4': '5-6',
      '5-6': '7-8',
      '7-8': '9-10',
      '9-10': 'Egresado'
    };

    // ==========================================
    // STORAGE MANAGER (NUBE)
    // ==========================================
    class StorageManager {
      constructor() { 
        this.collection = 'escuela_datos'; 
      }
      
      async getData() { 
        try {
          const snapshot = await db.collection(this.collection).get();
          return snapshot.docs.map(doc => ({ __backendId: doc.id, ...doc.data() }));
        } catch (error) {
          console.error("Error obteniendo datos de Firebase:", error);
          showToast("Error de conexi√≥n a la base de datos.", "error");
          return [];
        }
      }
      
      async addRecord(record) { 
        try {
          const dataToSave = { ...record };
          delete dataToSave.__backendId;
          const docRef = await db.collection(this.collection).add(dataToSave);
          record.__backendId = docRef.id;
          return record;
        } catch (error) {
          console.error("Error al guardar:", error);
          showToast("Error al guardar en la nube.", "error");
        }
      }
      
      async updateRecord(record) { 
        try {
          const dataToSave = { ...record };
          const id = dataToSave.__backendId;
          delete dataToSave.__backendId;
          await db.collection(this.collection).doc(id).update(dataToSave);
        } catch (error) {
          console.error("Error al actualizar:", error);
        }
      }
      
      async deleteRecord(id) { 
        try {
          await db.collection(this.collection).doc(id).delete();
        } catch (error) {
          console.error("Error al eliminar:", error);
        }
      }
    }

    const storage = new StorageManager();

    // Variables de Estado
    let allData = [];
    let currentUser = null; 
    let currentSection = '';
    let confirmCallback = null;
    let editAlumnoId = null;
    let editMaestroId = null; 
    let isReinscripcion = false; 
    let currentWAAlumnoId = null;

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
      toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg text-sm md:text-base`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    // ==========================================
    // SISTEMA DE ROLES Y LOGIN
    // ==========================================
    document.getElementById('login-form').addEventListener('submit', async function(e) {
      e.preventDefault();
      const userVal = document.getElementById('login-user').value.trim();
      const passVal = document.getElementById('login-pass').value.trim();
      const errorDiv = document.getElementById('login-error');
      const btnLogin = document.getElementById('btn-login');

      btnLogin.disabled = true;
      btnLogin.innerHTML = '<svg class="w-5 h-5 animate-spin mx-auto" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
      
      allData = await storage.getData(); 
      let loggedIn = false;

      // 1. Verificaci√≥n Admin
      if (userVal === 'admin' && passVal === 'admin') {
          currentUser = { role: 'admin', nombre: 'Administrador' };
          loggedIn = true;
      } else {
          // 2. Verificaci√≥n Maestro 
          const maestro = allData.find(d => d.type === 'maestro' && d.maestro_nombre.toLowerCase() === userVal.toLowerCase() && passVal === (d.maestro_password || '12345'));
          if (maestro) {
              currentUser = { role: 'maestro', nombre: maestro.maestro_nombre, id: maestro.__backendId };
              loggedIn = true;
          } else {
              // 3. Verificaci√≥n Alumno 
              const alumno = allData.find(d => d.type === 'alumno' && d.numero_control === userVal && passVal === (d.alumno_password || d.numero_control));
              if (alumno) {
                  currentUser = { role: 'alumno', nombre: alumno.nombre_completo, id: alumno.__backendId, data: alumno };
                  loggedIn = true;
              }
          }
      }

      if (loggedIn) {
          document.getElementById('login-screen').classList.add('hidden');
          document.getElementById('dashboard').classList.remove('hidden');
          document.getElementById('dashboard').classList.add('flex');
          
          document.getElementById('sidebar-title').textContent = currentUser.nombre;
          document.getElementById('sidebar-role').textContent = currentUser.role.toUpperCase();

          renderUIBasedOnRole();
          showToast(`¬°Bienvenido, ${currentUser.nombre}!`);
      } else {
          errorDiv.textContent = 'Usuario o contrase√±a incorrectos';
          errorDiv.classList.remove('hidden');
      }

      btnLogin.disabled = false;
      btnLogin.textContent = 'Iniciar Sesi√≥n';
    });

    function logout() {
      currentUser = null;
      document.getElementById('dashboard').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('flex');
      document.getElementById('login-screen').classList.remove('hidden');
      document.getElementById('login-user').value = '';
      document.getElementById('login-pass').value = '';
      document.getElementById('login-error').classList.add('hidden');
    }

    function renderUIBasedOnRole() {
      document.querySelectorAll('.sidebar-item').forEach(el => el.classList.add('hidden'));
      document.getElementById('stats-header').classList.add('hidden');

      if (currentUser.role === 'admin') {
          ['nav-alumnos', 'nav-maestros', 'nav-grupos', 'nav-listas', 'nav-calificaciones', 'nav-historial'].forEach(id => document.getElementById(id)?.classList.remove('hidden'));
          document.getElementById('stats-header').classList.remove('hidden');
          document.getElementById('stat-card-maestros').classList.remove('hidden');
          document.getElementById('th-acciones-calif').classList.remove('hidden');
          loadAllData();
          showSection('alumnos');

      } else if (currentUser.role === 'maestro') {
          ['nav-listas', 'nav-calificaciones'].forEach(id => document.getElementById(id)?.classList.remove('hidden'));
          document.getElementById('stats-header').classList.remove('hidden');
          document.getElementById('stat-card-maestros').classList.add('hidden'); 
          
          document.getElementById('card-captura-calificaciones').classList.remove('hidden');
          document.getElementById('th-acciones-calif').classList.add('hidden');

          loadAllData();
          showSection('calificaciones');

      } else if (currentUser.role === 'alumno') {
          ['nav-mis-calificaciones'].forEach(id => document.getElementById(id)?.classList.remove('hidden'));
          showSection('mis-calificaciones');
          renderMisCalificaciones();
      }
    }

    function showSection(section) {
      currentSection = section;
      ['alumnos', 'maestros', 'grupos', 'listas', 'calificaciones', 'historial', 'mis-calificaciones'].forEach(s => {
        document.getElementById(`section-${s}`)?.classList.add('hidden');
      });
      document.getElementById(`section-${section}`)?.classList.remove('hidden');
      
      document.querySelectorAll('.sidebar-item').forEach(btn => {
        btn.classList.remove('bg-white/20');
        if (btn.dataset.section === section) {
          btn.classList.add('bg-white/20');
        }
      });

      if (section === 'calificaciones') {
        actualizarEstadisticasCalificaciones();
        actualizarSelectsCalificaciones();
      }
      if (section === 'historial') {
        updateHistorialSelect();
      }

      // Cerrar el men√∫ en m√≥viles despu√©s de hacer clic en una secci√≥n
      if (window.innerWidth < 768) {
        const sidebar = document.getElementById('sidebar');
        if (!sidebar.classList.contains('-translate-x-full')) {
            toggleMobileMenu();
        }
      }
    }

    // ==========================================
    // L√ìGICA EXCLUSIVA DEL ALUMNO
    // ==========================================
    function renderMisCalificaciones() {
      const alumno = currentUser.data;
      document.getElementById('alumno-perfil-nombre').textContent = alumno.nombre_completo;
      document.getElementById('alumno-perfil-info').textContent = `${alumno.numero_control} ‚Ä¢ ${alumno.carrera}`;

      const misCalificaciones = allData.filter(d => d.type === 'calificacion' && d.alumno_id === alumno.__backendId);
      const tbody = document.getElementById('tabla-mis-calificaciones');

      if (misCalificaciones.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400">A√∫n no tienes calificaciones registradas.</td></tr>';
        return;
      }

      tbody.innerHTML = misCalificaciones.map(calif => {
        const grupo = allData.find(g => g.__backendId === calif.grupo_id);
        const mod = grupo ? grupo.modulo : 'N/A';
        const p1 = calif.parcial_1 ?? '-'; const p2 = calif.parcial_2 ?? '-'; const p3 = calif.parcial_3 ?? '-'; const p4 = calif.parcial_4 ?? '-'; 
        const promedio = calif.promedio ?? '-'; const estado = calif.estado ?? 'SIN CALIFICAR';
        const estadoClass = estado === 'APROBADO' ? 'bg-green-100 text-green-700' : estado === 'REPROBADO' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700';

        return `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="py-3 px-4 text-sm text-gray-800 font-medium">${calif.grupo_nombre}</td>
            <td class="py-3 px-4 text-sm text-gray-600">${mod}</td>
            <td class="py-3 px-4 text-center text-sm text-gray-600">${p1}</td>
            <td class="py-3 px-4 text-center text-sm text-gray-600">${p2}</td>
            <td class="py-3 px-4 text-center text-sm text-gray-600">${p3}</td>
            <td class="py-3 px-4 text-center text-sm text-gray-600">${p4}</td>
            <td class="py-3 px-4 text-center text-sm font-bold text-gray-800">${promedio}</td>
            <td class="py-3 px-4 text-center"><span class="px-3 py-1 text-xs font-semibold rounded-full ${estadoClass}">${estado}</span></td>
          </tr>
        `;
      }).join('');
    }

    // ==========================================
    // FUNCIONES BASE
    // ==========================================
    function showConfirmModal(title, message, btnText, btnClass, callback) {
      document.getElementById('confirm-modal-title').textContent = title;
      document.getElementById('confirm-modal-text').textContent = message;
      const confirmBtn = document.getElementById('confirm-action-btn');
      confirmBtn.textContent = btnText;
      confirmBtn.className = `px-4 py-2 text-white rounded-lg transition w-full sm:w-auto ${btnClass}`;
      document.getElementById('confirm-modal').classList.remove('hidden');
      confirmCallback = callback;
    }

    function closeConfirmModal() {
      document.getElementById('confirm-modal').classList.add('hidden');
      confirmCallback = null;
    }

    document.getElementById('confirm-action-btn').addEventListener('click', async function() {
      if (confirmCallback) { await confirmCallback(); closeConfirmModal(); }
    });

    function openWAModal(id) {
      const alumno = allData.find(a => a.__backendId === id);
      if (!alumno || !alumno.telefono) { showToast('El alumno no tiene un n√∫mero registrado.', 'error'); return; }
      currentWAAlumnoId = id;
      document.getElementById('wa-alumno-nombre').textContent = alumno.nombre_completo;
      document.getElementById('whatsapp-modal').classList.remove('hidden');
    }

    function closeWAModal() { document.getElementById('whatsapp-modal').classList.add('hidden'); currentWAAlumnoId = null; }

    function sendWA(type) {
      const alumno = allData.find(a => a.__backendId === currentWAAlumnoId);
      if (!alumno) return;
      let rawPhone = alumno.telefono.replace(/\D/g, '');
      if(rawPhone.length === 10) rawPhone = '52' + rawPhone; 
      let message = "";
      
      if (type === 'saludo') message = `Hola ${alumno.nombre_completo}, te escribimos del Centro de Idiomas.`;
      else if (type === 'pago') message = `Hola ${alumno.nombre_completo}. Este es un recordatorio amigable del Centro de Idiomas sobre tu pr√≥ximo pago de colegiatura. Quedamos a tu disposici√≥n para cualquier duda.`;
      else if (type === 'aviso') message = `Hola ${alumno.nombre_completo}, te contactamos del Centro de Idiomas para darte un aviso importante: `;
      else if (type === 'calificaciones') {
         const calif = getCalificacionesByGrupo(alumno.grupo_id).find(c => c.alumno_id === alumno.__backendId);
         if(calif) message = `Hola ${alumno.nombre_completo}, te compartimos tus calificaciones del M√≥dulo ${alumno.modulo}:\n\nüìù Parcial 1: ${calif.parcial_1}\nüìù Parcial 2: ${calif.parcial_2}\nüìù Parcial 3: ${calif.parcial_3}\nüìù Parcial 4: ${calif.parcial_4}\n\nüéØ *Promedio Final: ${calif.promedio}*\nüìå Estado: ${calif.estado}\n\n¬°Excelente d√≠a!`;
         else message = `Hola ${alumno.nombre_completo}, tus calificaciones a√∫n no han sido registradas en el sistema para este m√≥dulo. Te avisaremos en cuanto est√©n listas.`;
      }
      window.open(`https://wa.me/${rawPhone}?text=${encodeURIComponent(message)}`, '_blank');
      closeWAModal();
    }


    function getAlumnos() { 
        let alumnos = allData.filter(d => d.type === 'alumno'); 
        if (currentUser?.role === 'maestro') {
            const misGruposIds = getGrupos().map(g => g.__backendId);
            alumnos = alumnos.filter(a => misGruposIds.includes(a.grupo_id));
        }
        return alumnos;
    }
    
    function getMaestros() { return allData.filter(d => d.type === 'maestro'); }
    
    function getGrupos() { 
        let grupos = allData.filter(d => d.type === 'grupo' && !d.ciclo_cerrado); 
        if (currentUser?.role === 'maestro') {
            grupos = grupos.filter(g => g.maestro_id === currentUser.id);
        }
        return grupos;
    }
    
    function getGruposCerrados() { return allData.filter(d => d.type === 'grupo' && d.ciclo_cerrado); }
    function getAlumnosByGrupo(grupoId) { return allData.filter(d => d.type === 'alumno' && d.grupo_id === grupoId); }

    async function loadAllData() {
      allData = await storage.getData();
      if (currentUser?.role === 'alumno') {
         renderMisCalificaciones();
      } else {
         updateStats(); updateGrupoSelects(); updateMaestroSelect(); updateHistorialSelect();
         renderAlumnos(); renderMaestros(); renderGrupos(); renderListaPreview();
      }
    }

    function updateStats() {
      document.getElementById('stat-alumnos').textContent = getAlumnos().length;
      document.getElementById('stat-maestros').textContent = getMaestros().length;
      document.getElementById('stat-grupos').textContent = getGrupos().length;
    }

    function updateGrupoSelects() {
      const grupos = getGrupos();
      const selects = [
        document.getElementById('alumno-grupo'),
        document.getElementById('lista-grupo-select')
      ];

      selects.forEach(select => {
        if (!select) return;
        const currentValue = select.value;
        const isAlumnoSelect = select.id === 'alumno-grupo';
        select.innerHTML = `<option value="">${isAlumnoSelect ? 'Selecciona un grupo' : 'Selecciona un grupo'}</option>`;
        
        grupos.forEach(grupo => {
          const alumnosCount = getAlumnosByGrupo(grupo.__backendId).length;
          const isFull = alumnosCount >= 25;
          const option = document.createElement('option');
          option.value = grupo.__backendId;
          option.textContent = `${grupo.grupo_nombre} (${alumnosCount}/25)${isFull ? ' - LLENO' : ''}`;
          
          if (isAlumnoSelect && isFull) {
             const isOwnGroup = editAlumnoId && allData.find(a => a.__backendId === editAlumnoId)?.grupo_id === grupo.__backendId;
             if (!isOwnGroup) option.disabled = true;
          }
          select.appendChild(option);
        });

        if (currentValue && grupos.some(g => g.__backendId === currentValue)) {
          select.value = currentValue;
        }
      });
    }

    function updateMaestroSelect() {
      const maestros = getMaestros();
      const select = document.getElementById('grupo-maestro');
      const currentValue = select.value;
      select.innerHTML = '<option value="">Sin asignar</option>';
      maestros.forEach(maestro => {
        const option = document.createElement('option');
        option.value = maestro.__backendId;
        option.textContent = `${maestro.maestro_nombre} - ${maestro.maestro_especialidad}`;
        select.appendChild(option);
      });
      if (currentValue && maestros.some(m => m.__backendId === currentValue)) { select.value = currentValue; }
    }

    // ==========================================
    // L√ìGICA DE ALUMNOS
    // ==========================================
    function renderAlumnos() {
      const tbody = document.getElementById('tabla-alumnos'); const alumnos = getAlumnos();
      if (alumnos.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="py-8 text-center text-gray-400">No hay alumnos registrados</td></tr>'; return; }

      tbody.innerHTML = alumnos.map(alumno => {
        const grupo = allData.find(d => d.__backendId === alumno.grupo_id);
        const grupoNombre = grupo ? grupo.grupo_nombre : 'Sin grupo';
        const isClosed = grupo && grupo.ciclo_cerrado;
        const hasPhone = alumno.telefono && alumno.telefono.replace(/\D/g, '').length >= 10;
        const whatsappClass = hasPhone ? 'text-green-500 hover:text-green-600 bg-green-50 cursor-pointer' : 'text-gray-300 bg-gray-50 cursor-not-allowed';
        const waAction = hasPhone ? `onclick="openWAModal('${alumno.__backendId}')"` : `title="Sin tel√©fono registrado"`;

        let statusBadge = '';
        if (isClosed) {
            const calif = getCalificacionesByGrupo(alumno.grupo_id).find(c => c.alumno_id === alumno.__backendId);
            if (calif && calif.estado === 'APROBADO') {
                const nextMod = nextModuleMap[alumno.modulo] || 'Egresado';
                statusBadge = `<div class="mt-2"><span class="px-2 py-1 text-[10px] font-semibold bg-blue-100 text-blue-800 rounded-full shadow-sm">üéì Candidato a M√≥dulo ${nextMod}</span></div>`;
            } else if (calif && calif.estado === 'REPROBADO') {
                statusBadge = `<div class="mt-2"><span class="px-2 py-1 text-[10px] font-semibold bg-orange-100 text-orange-800 rounded-full shadow-sm">üîÑ Recursa M√≥dulo ${alumno.modulo}</span></div>`;
            } else {
                statusBadge = `<div class="mt-2"><span class="px-2 py-1 text-[10px] font-semibold bg-gray-100 text-gray-800 rounded-full shadow-sm">‚ö†Ô∏è Sin Calificar</span></div>`;
            }
        }

        return `
        <tr class="border-b border-gray-100 hover:bg-gray-50 ${editAlumnoId === alumno.__backendId ? 'bg-purple-50' : ''}">
          <td class="py-3 px-4 text-sm text-gray-800 whitespace-nowrap">
             ${alumno.nombre_completo}
          </td>
          <td class="py-3 px-4 text-sm text-gray-600">
             ${alumno.numero_control}
             <div class="text-[10px] text-gray-400 mt-1">Pass: ${alumno.alumno_password || alumno.numero_control}</div>
          </td>
          <td class="py-3 px-4 text-sm text-gray-600">${alumno.carrera}</td>
          <td class="py-3 px-4"><span class="px-2 py-1 text-xs font-medium bg-green-100 text-green-700 rounded-full">${alumno.modulo}</span></td>
          <td class="py-3 px-4 text-sm text-gray-600 leading-tight">
             ${grupoNombre} ${isClosed ? '<span class="text-xs text-red-500 font-medium ml-1">(Cerrado)</span>' : ''} ${statusBadge}
          </td>
          <td class="py-3 px-4 flex justify-center items-center gap-2">
            <button ${waAction} class="${whatsappClass} p-2 rounded" title="${hasPhone ? 'Opciones de WhatsApp' : 'Sin tel√©fono registrado'}">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.017-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
            </button>
            ${isClosed ? `
            <button onclick="reinscribirAlumnoBtn('${alumno.__backendId}')" class="text-purple-600 hover:text-purple-800 p-2 bg-purple-50 rounded" title="Reinscribir al siguiente M√≥dulo">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg>
            </button>` : `
            <button onclick="editarAlumnoBtn('${alumno.__backendId}')" class="text-blue-500 hover:text-blue-700 p-2 bg-blue-50 rounded" title="Editar Alumno">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
            </button>`}
            <button onclick="deleteAlumno('${alumno.__backendId}')" class="text-red-500 hover:text-red-700 p-2 bg-red-50 rounded" title="Eliminar Alumno">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
            </button>
          </td>
        </tr>
      `}).join('');
    }

    function editarAlumnoBtn(id) {
      const alumno = allData.find(d => d.__backendId === id);
      if (!alumno) return;
      editAlumnoId = id; isReinscripcion = false;
      document.getElementById('alumno-nombre').value = alumno.nombre_completo;
      document.getElementById('alumno-control').value = alumno.numero_control;
      document.getElementById('alumno-carrera').value = alumno.carrera;
      document.getElementById('alumno-modalidad').value = alumno.modalidad;
      document.getElementById('alumno-modulo').value = alumno.modulo;
      document.getElementById('alumno-telefono').value = alumno.telefono || '';
      document.getElementById('alumno-password').value = alumno.alumno_password || ''; // Cargar Password
      
      updateGrupoSelects();
      const selectGrupo = document.getElementById('alumno-grupo');
      if(Array.from(selectGrupo.options).some(opt => opt.value === alumno.grupo_id)) { selectGrupo.value = alumno.grupo_id; }
      
      document.getElementById('titulo-form-alumno').innerHTML = `<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg> Editando Alumno`;
      document.getElementById('texto-btn-alumno').textContent = 'Guardar Cambios';
      document.getElementById('icono-btn-alumno').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
      document.getElementById('btn-cancelar-edicion-alumno').classList.remove('hidden');
      document.getElementById('section-alumnos').scrollIntoView({ behavior: 'smooth' });
      renderAlumnos();
    }

    function reinscribirAlumnoBtn(id) {
      const alumno = allData.find(d => d.__backendId === id);
      if (!alumno) return;
      editAlumnoId = id; isReinscripcion = true;
      const calif = getCalificacionesByGrupo(alumno.grupo_id).find(c => c.alumno_id === id);
      let sugerenciaModulo = alumno.modulo;
      if (calif && calif.estado === 'APROBADO') { sugerenciaModulo = nextModuleMap[alumno.modulo] || 'Egresado'; }
      
      document.getElementById('alumno-nombre').value = alumno.nombre_completo;
      document.getElementById('alumno-control').value = alumno.numero_control;
      document.getElementById('alumno-carrera').value = alumno.carrera;
      document.getElementById('alumno-modalidad').value = alumno.modalidad;
      document.getElementById('alumno-telefono').value = alumno.telefono || '';
      document.getElementById('alumno-password').value = alumno.alumno_password || ''; 
      
      if (sugerenciaModulo !== 'Egresado') { document.getElementById('alumno-modulo').value = sugerenciaModulo; }
      
      updateGrupoSelects();
      document.getElementById('alumno-grupo').value = ""; 
      document.getElementById('titulo-form-alumno').innerHTML = `<svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path></svg> Reinscribiendo Alumno`;
      document.getElementById('texto-btn-alumno').textContent = 'Confirmar Reinscripci√≥n';
      document.getElementById('icono-btn-alumno').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
      document.getElementById('btn-cancelar-edicion-alumno').classList.remove('hidden');
      document.getElementById('section-alumnos').scrollIntoView({ behavior: 'smooth' });
      renderAlumnos();
    }

    function cancelarEdicionAlumno() {
      editAlumnoId = null; isReinscripcion = false; document.getElementById('form-alumno').reset();
      document.getElementById('titulo-form-alumno').innerHTML = `<svg class="w-6 h-6 text-blue-800" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg> Registrar Nuevo Alumno`;
      document.getElementById('texto-btn-alumno').textContent = 'Registrar Alumno';
      document.getElementById('icono-btn-alumno').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>';
      document.getElementById('btn-cancelar-edicion-alumno').classList.add('hidden');
      updateGrupoSelects(); renderAlumnos();
    }

    document.getElementById('form-alumno').addEventListener('submit', async function(e) {
      e.preventDefault();
      const grupoId = document.getElementById('alumno-grupo').value;
      const grupo = allData.find(d => d.__backendId === grupoId);
      if (!grupo) { showToast('Por favor selecciona un grupo v√°lido', 'error'); return; }
      
      const alumnosInGrupo = getAlumnosByGrupo(grupoId);
      const isSameGroup = editAlumnoId && allData.find(a => a.__backendId === editAlumnoId)?.grupo_id === grupoId;

      if (!isSameGroup && alumnosInGrupo.length >= 25) { showToast('Este grupo ya est√° lleno (25 alumnos)', 'error'); return; }

      const btn = document.getElementById('btn-registrar-alumno');
      btn.disabled = true; const originalBtnHtml = btn.innerHTML;
      btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Procesando...</span>';

      if (editAlumnoId) {
        const alumnoToUpdate = allData.find(a => a.__backendId === editAlumnoId);
        if(alumnoToUpdate) {
           alumnoToUpdate.nombre_completo = document.getElementById('alumno-nombre').value;
           alumnoToUpdate.numero_control = document.getElementById('alumno-control').value;
           alumnoToUpdate.carrera = document.getElementById('alumno-carrera').value;
           alumnoToUpdate.modalidad = document.getElementById('alumno-modalidad').value;
           alumnoToUpdate.modulo = document.getElementById('alumno-modulo').value;
           alumnoToUpdate.telefono = document.getElementById('alumno-telefono').value;
           alumnoToUpdate.alumno_password = document.getElementById('alumno-password').value; // Guardar Password Editado
           alumnoToUpdate.grupo_id = grupoId;
           alumnoToUpdate.grupo_nombre = grupo.grupo_nombre;

           await storage.updateRecord(alumnoToUpdate);
           showToast(isReinscripcion ? 'Alumno reinscrito correctamente' : 'Alumno actualizado correctamente');
        }
        btn.innerHTML = originalBtnHtml; cancelarEdicionAlumno(); 
      } else {
        const alumno = {
          type: 'alumno', 
          nombre_completo: document.getElementById('alumno-nombre').value, 
          numero_control: document.getElementById('alumno-control').value, 
          carrera: document.getElementById('alumno-carrera').value, 
          modalidad: document.getElementById('alumno-modalidad').value, 
          modulo: document.getElementById('alumno-modulo').value, 
          telefono: document.getElementById('alumno-telefono').value, 
          alumno_password: document.getElementById('alumno-password').value, // Guardar nuevo Password
          grupo_id: grupoId, 
          grupo_nombre: grupo.grupo_nombre, 
          created_at: new Date().toISOString()
        };
        await storage.addRecord(alumno);
        showToast('Alumno registrado correctamente');
        btn.innerHTML = originalBtnHtml; e.target.reset();
      }
      await loadAllData();
      btn.disabled = false;
    });

    // ==========================================
    // L√ìGICA DE MAESTROS
    // ==========================================
    function renderMaestros() {
      const container = document.getElementById('lista-maestros'); const maestros = getMaestros();
      if (maestros.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 py-8 col-span-full">No hay maestros registrados</div>'; return; }
      
      container.innerHTML = maestros.map(maestro => `
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 card-hover ${editMaestroId === maestro.__backendId ? 'border-blue-400 bg-blue-50' : ''}">
          <div class="flex items-start justify-between">
            <div class="flex items-center gap-3 w-3/4">
              <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
              </div>
              <div class="overflow-hidden">
                <h4 class="font-semibold text-gray-800 truncate">${maestro.maestro_nombre}</h4>
                <p class="text-sm text-gray-500 truncate">${maestro.maestro_especialidad}</p>
                <p class="text-xs text-gray-400 mt-1 truncate">Pass: ${maestro.maestro_password || '12345'}</p>
              </div>
            </div>
            <div class="flex flex-col gap-1 flex-shrink-0">
              <button onclick="editarMaestroBtn('${maestro.__backendId}')" class="text-blue-500 hover:text-blue-700 p-2 bg-white rounded shadow-sm" title="Editar Maestro">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
              </button>
              <button onclick="deleteMaestro('${maestro.__backendId}')" class="text-red-500 hover:text-red-700 p-2 bg-white rounded shadow-sm" title="Eliminar Maestro">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function editarMaestroBtn(id) {
      const maestro = allData.find(d => d.__backendId === id);
      if (!maestro) return;
      
      editMaestroId = id;
      document.getElementById('maestro-nombre').value = maestro.maestro_nombre;
      document.getElementById('maestro-especialidad').value = maestro.maestro_especialidad;
      document.getElementById('maestro-password').value = maestro.maestro_password || '';

      document.getElementById('titulo-form-maestro').innerHTML = `<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg> Editando Maestro`;
      document.getElementById('texto-btn-maestro').textContent = 'Guardar Cambios';
      document.getElementById('icono-btn-maestro').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>';
      document.getElementById('btn-cancelar-edicion-maestro').classList.remove('hidden');
      document.getElementById('section-maestros').scrollIntoView({ behavior: 'smooth' });
      renderMaestros();
    }

    function cancelarEdicionMaestro() {
      editMaestroId = null; 
      document.getElementById('form-maestro').reset();
      document.getElementById('titulo-form-maestro').innerHTML = `<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z"></path></svg> Registrar Nuevo Maestro`;
      document.getElementById('texto-btn-maestro').textContent = 'Registrar Maestro';
      document.getElementById('icono-btn-maestro').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>';
      document.getElementById('btn-cancelar-edicion-maestro').classList.add('hidden');
      renderMaestros();
    }

    document.getElementById('form-maestro').addEventListener('submit', async function(e) {
      e.preventDefault();
      const btn = document.getElementById('btn-registrar-maestro'); 
      btn.disabled = true; 
      const originalBtnHtml = btn.innerHTML;
      btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Procesando...';
      
      if (editMaestroId) {
         const maestroToUpdate = allData.find(m => m.__backendId === editMaestroId);
         if(maestroToUpdate) {
             maestroToUpdate.maestro_nombre = document.getElementById('maestro-nombre').value;
             maestroToUpdate.maestro_especialidad = document.getElementById('maestro-especialidad').value;
             maestroToUpdate.maestro_password = document.getElementById('maestro-password').value;
             await storage.updateRecord(maestroToUpdate);
             showToast('Maestro actualizado correctamente');
         }
         btn.innerHTML = originalBtnHtml; 
         cancelarEdicionMaestro(); 
      } else {
          const maestro = { 
              type: 'maestro', 
              maestro_nombre: document.getElementById('maestro-nombre').value, 
              maestro_especialidad: document.getElementById('maestro-especialidad').value, 
              maestro_password: document.getElementById('maestro-password').value, 
              created_at: new Date().toISOString() 
          };
          await storage.addRecord(maestro); 
          showToast('Maestro registrado correctamente'); 
          btn.innerHTML = originalBtnHtml;
          e.target.reset();
      }
      
      await loadAllData();
      btn.disabled = false;
    });

    function deleteMaestro(id) {
      const maestro = allData.find(d => d.__backendId === id); if (!maestro) return;
      showConfirmModal('Eliminar Maestro', `¬øEst√°s seguro de eliminar al maestro "${maestro.maestro_nombre}"?`, 'Eliminar', 'bg-red-600 hover:bg-red-700', async () => {
        await storage.deleteRecord(id); 
        if(editMaestroId === id) cancelarEdicionMaestro();
        await loadAllData(); 
        showToast('Maestro eliminado correctamente');
      });
    }

    // ==========================================
    // L√ìGICA DE GRUPOS
    // ==========================================
    function renderGrupos() {
      const container = document.getElementById('lista-grupos'); const grupos = getGrupos(); 
      if (grupos.length === 0) { container.innerHTML = '<div class="text-center text-gray-400 py-8 col-span-full">No hay grupos activos creados</div>'; return; }
      container.innerHTML = grupos.map(grupo => {
        const alumnosCount = getAlumnosByGrupo(grupo.__backendId).length; const isFull = alumnosCount >= 25; const maestro = allData.find(d => d.__backendId === grupo.maestro_id);
        return `
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 card-hover">
            <div class="flex items-start justify-between mb-3">
              <div class="w-3/4">
                <h4 class="font-semibold text-gray-800 truncate">${grupo.grupo_nombre}</h4>
                <p class="text-sm text-gray-500 truncate">M√≥dulo ${grupo.modulo} | Periodo: ${grupo.periodo || 'Sin asignar'}</p>
              </div>
              <div class="flex gap-2 flex-shrink-0">
                <button onclick="confirmarCerrarCiclo('${grupo.__backendId}')" class="text-blue-500 hover:text-blue-700 bg-blue-100 hover:bg-blue-200 rounded p-2 transition" title="Cerrar Ciclo Escolar">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
                </button>
                <button onclick="deleteGrupo('${grupo.__backendId}')" class="text-red-500 hover:text-red-700 bg-red-100 hover:bg-red-200 rounded p-2 transition" title="Eliminar Grupo">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                </button>
              </div>
            </div>
            <div class="space-y-2">
              <div class="flex items-center gap-2 text-sm">
                <svg class="w-4 h-4 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span class="text-gray-600 truncate">${maestro ? maestro.maestro_nombre : 'Sin maestro asignado'}</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="flex-1 bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full ${isFull ? 'bg-red-500' : alumnosCount > 20 ? 'bg-yellow-500' : 'bg-green-500'}" style="width: ${(alumnosCount / 25) * 100}%"></div></div>
                <span class="text-sm font-medium ${isFull ? 'text-red-600' : 'text-gray-600'} flex-shrink-0">${alumnosCount}/25</span>
              </div>
              ${isFull ? '<span class="inline-block px-2 py-1 text-xs font-medium bg-red-100 text-red-700 rounded-full">GRUPO COMPLETO</span>' : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    document.getElementById('form-grupo').addEventListener('submit', async function(e) {
      e.preventDefault();
      const btn = document.getElementById('btn-crear-grupo'); btn.disabled = true; btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Creando...';
      const maestroId = document.getElementById('grupo-maestro').value;
      const grupo = { type: 'grupo', grupo_nombre: document.getElementById('grupo-nombre').value, modulo: document.getElementById('grupo-modulo').value, maestro_id: maestroId || null, periodo: document.getElementById('grupo-periodo').value, ciclo_cerrado: false, created_at: new Date().toISOString() };
      await storage.addRecord(grupo); await loadAllData();
      btn.disabled = false; btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> Crear Grupo';
      showToast('Grupo creado correctamente'); e.target.reset();
    });

    function deleteGrupo(id) {
      const grupo = allData.find(d => d.__backendId === id); if (!grupo) return;
      const alumnosInGrupo = getAlumnosByGrupo(id);
      if (alumnosInGrupo.length > 0) { showToast(`No se puede eliminar el grupo porque tiene ${alumnosInGrupo.length} alumno(s) asignado(s)`, 'error'); return; }
      showConfirmModal('Eliminar Grupo', `¬øEst√°s seguro de eliminar el grupo "${grupo.grupo_nombre}"?`, 'Eliminar', 'bg-red-600 hover:bg-red-700', async () => {
        await storage.deleteRecord(id); await loadAllData(); showToast('Grupo eliminado correctamente');
      });
    }

    function confirmarCerrarCiclo(id) {
      const grupo = allData.find(d => d.__backendId === id);
      if (!grupo) return;
      showConfirmModal('Cerrar Ciclo Escolar', `¬øEst√°s seguro de cerrar el ciclo del grupo "${grupo.grupo_nombre}"? Este grupo pasar√° al Historial y sus calificaciones se congelar√°n.`, 'Cerrar Ciclo', 'bg-blue-600 hover:bg-blue-700', () => cerrarCicloGrupo(id));
    }

    async function cerrarCicloGrupo(id) {
      const grupo = allData.find(d => d.__backendId === id);
      if (grupo) {
        const alumnos = getAlumnosByGrupo(id);
        for (let alumno of alumnos) {
           const hasGrade = allData.find(d => d.type === 'calificacion' && d.alumno_id === alumno.__backendId && d.grupo_id === id);
           if (!hasGrade) {
              await storage.addRecord({ type: 'calificacion', alumno_id: alumno.__backendId, grupo_id: id, nombre_completo: alumno.nombre_completo, numero_control: alumno.numero_control, grupo_nombre: grupo.grupo_nombre, parcial_1: '-', parcial_2: '-', parcial_3: '-', parcial_4: '-', promedio: '-', estado: 'SIN CALIFICAR', created_at: new Date().toISOString() });
           }
        }
        grupo.ciclo_cerrado = true;
        await storage.updateRecord(grupo);
        await loadAllData();
        showToast('Ciclo cerrado y listado de candidatos actualizado', 'success');
        showSection('historial');
        setTimeout(() => { const select = document.getElementById('historial-grupo-select'); select.value = id; select.dispatchEvent(new Event('change')); }, 200);
      }
    }

    function confirmarReabrirGrupo(id) {
      const grupo = allData.find(d => d.__backendId === id);
      if (!grupo) return;
      showConfirmModal('Reabrir Grupo', `¬øEst√°s seguro de reabrir el grupo "${grupo.grupo_nombre}"? Volver√° a aparecer en las listas activas.`, 'Reabrir Grupo', 'bg-green-600 hover:bg-green-700', () => reabrirGrupo(id));
    }

    async function reabrirGrupo(id) {
      const grupo = allData.find(d => d.__backendId === id);
      if (grupo) {
        grupo.ciclo_cerrado = false;
        await storage.updateRecord(grupo);
        await loadAllData();
        showToast('El grupo ha sido reabierto exitosamente', 'success');
        document.getElementById('historial-grupo-select').value = '';
        document.getElementById('historial-content').classList.add('hidden');
        document.getElementById('historial-empty').classList.remove('hidden');
        showSection('grupos');
      }
    }

    function updateHistorialSelect() {
      const gruposCerrados = getGruposCerrados(); const select = document.getElementById('historial-grupo-select'); const currentValue = select.value;
      select.innerHTML = '<option value="">Selecciona un grupo</option>';
      gruposCerrados.forEach(grupo => {
        const option = document.createElement('option'); option.value = grupo.__backendId; option.textContent = `${grupo.grupo_nombre} (${grupo.periodo || 'Sin periodo'}) - Cerrado`; select.appendChild(option);
      });
      if (currentValue && gruposCerrados.some(g => g.__backendId === currentValue)) { select.value = currentValue; }
    }

    document.getElementById('historial-grupo-select').addEventListener('change', function() {
      const grupoId = this.value; const contentDiv = document.getElementById('historial-content'); const emptyDiv = document.getElementById('historial-empty'); const tbody = document.getElementById('historial-alumnos-body'); const btnReabrir = document.getElementById('btn-reabrir-grupo');
      if (!grupoId) { contentDiv.classList.add('hidden'); emptyDiv.classList.remove('hidden'); return; }

      const grupo = allData.find(d => d.__backendId === grupoId);
      const maestro = allData.find(d => d.__backendId === grupo?.maestro_id);
      const calificaciones = getCalificacionesByGrupo(grupoId);

      document.getElementById('historial-grupo-titulo').textContent = grupo.grupo_nombre;
      document.getElementById('historial-grupo-info').textContent = `M√≥dulo ${grupo.modulo} | Periodo: ${grupo.periodo || 'Sin asignar'} | Maestro: ${maestro ? maestro.maestro_nombre : 'Sin asignar'} | Total Alumnos: ${calificaciones.length}`;

      btnReabrir.onclick = () => confirmarReabrirGrupo(grupoId);
      
      if (currentUser.role === 'admin') { btnReabrir.classList.remove('hidden'); } else { btnReabrir.classList.add('hidden'); }

      if (calificaciones.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="py-6 text-center text-gray-400">Este grupo se cerr√≥ sin alumnos</td></tr>';
      } else {
        tbody.innerHTML = calificaciones.map(calif => {
          const p1 = calif?.parcial_1 ?? '-'; const p2 = calif?.parcial_2 ?? '-'; const p3 = calif?.parcial_3 ?? '-'; const p4 = calif?.parcial_4 ?? '-'; const promedio = calif?.promedio ?? '-'; const estado = calif?.estado ?? 'SIN CALIFICAR';
          const estadoClass = estado === 'APROBADO' ? 'bg-green-100 text-green-700' : estado === 'REPROBADO' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700';
          return `
            <tr class="border-b border-gray-200 hover:bg-white transition">
              <td class="py-3 px-4 text-sm text-gray-800 font-medium whitespace-nowrap">${calif.nombre_completo} <span class="block text-xs text-gray-500 font-normal">No. ${calif.numero_control}</span></td>
              <td class="py-3 px-4 text-center text-sm text-gray-600">${p1}</td>
              <td class="py-3 px-4 text-center text-sm text-gray-600">${p2}</td>
              <td class="py-3 px-4 text-center text-sm text-gray-600">${p3}</td>
              <td class="py-3 px-4 text-center text-sm text-gray-600">${p4}</td>
              <td class="py-3 px-4 text-center text-sm font-bold text-gray-800">${promedio}</td>
              <td class="py-3 px-4 text-center"><span class="px-3 py-1 text-xs font-semibold rounded-full ${estadoClass}">${estado}</span></td>
            </tr>
          `;
        }).join('');
      }
      contentDiv.classList.remove('hidden'); emptyDiv.classList.add('hidden');
    });

    function renderListaPreview() {
      const grupoId = document.getElementById('lista-grupo-select').value;
      const previewDiv = document.getElementById('lista-preview'); const emptyDiv = document.getElementById('lista-empty');
      if (!grupoId) { previewDiv.classList.add('hidden'); emptyDiv.classList.remove('hidden'); return; }

      const grupo = allData.find(d => d.__backendId === grupoId); const alumnos = getAlumnosByGrupo(grupoId); const maestro = allData.find(d => d.__backendId === grupo?.maestro_id);

      if (grupo) {
        document.getElementById('lista-grupo-titulo').textContent = grupo.grupo_nombre;
        document.getElementById('lista-grupo-info').textContent = `M√≥dulo ${grupo.modulo} | Periodo: ${grupo.periodo || 'Sin asignar'} | Maestro: ${maestro ? maestro.maestro_nombre : 'Sin asignar'} | ${alumnos.length} alumnos`;
        const tbody = document.getElementById('lista-alumnos-body');
        if (alumnos.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-400">No hay alumnos en este grupo</td></tr>';
        } else {
          tbody.innerHTML = alumnos.map((alumno, idx) => `
            <tr class="border-b border-gray-200">
              <td class="py-2 px-3 text-sm text-gray-600">${idx + 1}</td>
              <td class="py-2 px-3 text-sm text-gray-800 font-medium whitespace-nowrap">${alumno.nombre_completo}</td>
              <td class="py-2 px-3 text-sm text-gray-600">${alumno.numero_control}</td>
              <td class="py-2 px-3 text-sm text-gray-600">${alumno.carrera}</td>
              <td class="py-2 px-3 text-sm text-gray-600">${alumno.modalidad}</td>
            </tr>
          `).join('');
        }
        previewDiv.classList.remove('hidden'); emptyDiv.classList.add('hidden');
      }
    }

    // ==========================================
    // CAPTURA DE CALIFICACIONES
    // ==========================================
    function getCalificacionesByGrupo(grupoId) { return allData.filter(d => d.type === 'calificacion' && d.grupo_id === grupoId); }

    function actualizarSelectsCalificaciones() {
      const grupos = getGrupos(); 
      const selectGrupo = document.getElementById('calif-grupo'); const selectGrupoView = document.getElementById('calif-grupo-view'); const selectBoleta = document.getElementById('boleta-grupo-select');
      const valGrupo = selectGrupo.value; const valView = selectGrupoView.value; const valBoleta = selectBoleta.value;

      selectGrupo.innerHTML = '<option value="">Selecciona un grupo</option>'; selectGrupoView.innerHTML = '<option value="">Selecciona un grupo</option>'; selectBoleta.innerHTML = '<option value="">Selecciona un grupo</option>';

      grupos.forEach(grupo => {
        const option1 = document.createElement('option'); option1.value = grupo.__backendId; option1.textContent = grupo.grupo_nombre; selectGrupo.appendChild(option1);
        const option2 = document.createElement('option'); option2.value = grupo.__backendId; option2.textContent = grupo.grupo_nombre; selectGrupoView.appendChild(option2);
        const option3 = document.createElement('option'); option3.value = grupo.__backendId; option3.textContent = grupo.grupo_nombre; selectBoleta.appendChild(option3);
      });

      if (valGrupo && grupos.some(g => g.__backendId === valGrupo)) selectGrupo.value = valGrupo;
      if (valView && grupos.some(g => g.__backendId === valView)) selectGrupoView.value = valView;
      if (valBoleta && grupos.some(g => g.__backendId === valBoleta)) selectBoleta.value = valBoleta;
    }

    document.getElementById('calif-grupo').addEventListener('change', function() {
      const grupoId = this.value; const selectAlumno = document.getElementById('calif-alumno');
      selectAlumno.innerHTML = '<option value="">Selecciona un alumno</option>';
      if (!grupoId) return;
      const alumnos = getAlumnosByGrupo(grupoId);
      alumnos.forEach(alumno => {
        const option = document.createElement('option'); option.value = alumno.__backendId; option.textContent = alumno.nombre_completo; selectAlumno.appendChild(option);
      });
    });

    function limpiarFormularioCalificaciones() {
      document.getElementById('form-calificaciones').reset(); document.getElementById('calif-alumno').innerHTML = '<option value="">Primero selecciona un grupo</option>'; document.getElementById('calif-parcial1').focus();
    }

    document.getElementById('form-calificaciones').addEventListener('submit', async function(e) {
      e.preventDefault();
      const grupoId = document.getElementById('calif-grupo').value; const alumnoId = document.getElementById('calif-alumno').value;
      const parcial1 = parseFloat(document.getElementById('calif-parcial1').value); const parcial2 = parseFloat(document.getElementById('calif-parcial2').value); const parcial3 = parseFloat(document.getElementById('calif-parcial3').value); const parcial4 = parseFloat(document.getElementById('calif-parcial4').value);

      if (!grupoId || !alumnoId) { showToast('Por favor completa todos los campos', 'error'); return; }

      const alumno = allData.find(d => d.__backendId === alumnoId); const grupo = allData.find(d => d.__backendId === grupoId);
      const promedio = ((parcial1 + parcial2 + parcial3 + parcial4) / 4).toFixed(2); const estado = promedio >= 70 ? 'APROBADO' : 'REPROBADO';

      const calificacionExistente = allData.find(d => d.type === 'calificacion' && d.alumno_id === alumnoId && d.grupo_id === grupoId);
      const btn = document.getElementById('btn-guardar-calificacion');
      btn.disabled = true; btn.innerHTML = '<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Guardando...';

      if (calificacionExistente) {
        const calificacionActualizada = { ...calificacionExistente, parcial_1: parcial1, parcial_2: parcial2, parcial_3: parcial3, parcial_4: parcial4, promedio: parseFloat(promedio), estado: estado };
        await storage.updateRecord(calificacionActualizada);
      } else {
        const calificacion = { type: 'calificacion', alumno_id: alumnoId, grupo_id: grupoId, nombre_completo: alumno.nombre_completo, numero_control: alumno.numero_control, grupo_nombre: grupo.grupo_nombre, parcial_1: parcial1, parcial_2: parcial2, parcial_3: parcial3, parcial_4: parcial4, promedio: parseFloat(promedio), estado: estado, created_at: new Date().toISOString() };
        await storage.addRecord(calificacion);
      }

      await loadAllData();
      btn.disabled = false; btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg> Guardar';
      showToast('Calificaci√≥n guardada correctamente');
      limpiarFormularioCalificaciones(); actualizarEstadisticasCalificaciones(); renderTablaCalificaciones(); renderAlumnos(); 
    });

    function renderTablaCalificaciones() {
      const grupoId = document.getElementById('calif-grupo-view').value;
      const tbody = document.getElementById('tabla-calificaciones');
      if (!grupoId) { tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400">Selecciona un grupo para ver las calificaciones</td></tr>'; return; }
      
      const calificaciones = getCalificacionesByGrupo(grupoId);
      const alumnos = getAlumnosByGrupo(grupoId);
      
      if (alumnos.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="py-8 text-center text-gray-400">No hay alumnos en este grupo</td></tr>'; return; }
      
      tbody.innerHTML = alumnos.map(alumno => {
        const calif = calificaciones.find(c => c.alumno_id === alumno.__backendId);
        const p1 = calif?.parcial_1 ?? '-'; const p2 = calif?.parcial_2 ?? '-'; const p3 = calif?.parcial_3 ?? '-'; const p4 = calif?.parcial_4 ?? '-'; const promedio = calif?.promedio ?? '-'; const estado = calif?.estado ?? 'SIN CALIFICAR';
        const estadoClass = estado === 'APROBADO' ? 'bg-green-100 text-green-700' : estado === 'REPROBADO' ? 'bg-red-100 text-red-700' : 'bg-gray-100 text-gray-700';
        
        let editBtn = '';
        if (currentUser.role === 'admin') {
            editBtn = calif ? `<button onclick="editarCalificacion('${calif.__backendId}')" class="text-indigo-500 hover:text-indigo-700 p-2 bg-indigo-50 rounded"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg></button>` : '-';
        }

        return `
          <tr class="border-b border-gray-100 hover:bg-gray-50">
            <td class="py-3 px-4 text-sm text-gray-800 font-medium whitespace-nowrap">${alumno.nombre_completo}</td>
            <td class="py-3 px-4 text-center text-sm text-gray-600">${p1}</td>
            <td class="py-3 px-4 text-center text-sm text-gray-600">${p2}</td>
            <td class="py-3 px-4 text-center text-sm text-gray-600">${p3}</td>
            <td class="py-3 px-4 text-center text-sm text-gray-600">${p4}</td>
            <td class="py-3 px-4 text-center text-sm font-semibold text-gray-800">${promedio}</td>
            <td class="py-3 px-4 text-center"><span class="px-3 py-1 text-xs font-semibold rounded-full ${estadoClass}">${estado}</span></td>
            ${currentUser.role === 'admin' ? `<td class="py-3 px-4 text-center">${editBtn}</td>` : ''}
          </tr>
        `;
      }).join('');
    }

    function actualizarEstadisticasCalificaciones() {
      const grupoId = document.getElementById('calif-grupo-view').value;
      if (!grupoId) { document.getElementById('stat-aprobacion').textContent = '0%'; document.getElementById('stat-reprobacion').textContent = '0%'; document.getElementById('stat-promedio-grupo').textContent = '0.0'; return; }
      
      const calificaciones = getCalificacionesByGrupo(grupoId);
      if (calificaciones.length === 0) { document.getElementById('stat-aprobacion').textContent = '0%'; document.getElementById('stat-reprobacion').textContent = '0%'; document.getElementById('stat-promedio-grupo').textContent = '0.0'; return; }
      
      const aprobados = calificaciones.filter(c => c.estado === 'APROBADO').length;
      const reprobados = calificaciones.filter(c => c.estado === 'REPROBADO').length;
      const porcentajeAprobacion = ((aprobados / calificaciones.length) * 100).toFixed(1);
      const porcentajeReprobacion = ((reprobados / calificaciones.length) * 100).toFixed(1);
      const promedioGrupo = (calificaciones.reduce((sum, c) => sum + parseFloat(c.promedio || 0), 0) / calificaciones.length).toFixed(2);
      
      document.getElementById('stat-aprobacion').textContent = porcentajeAprobacion + '%';
      document.getElementById('stat-reprobacion').textContent = porcentajeReprobacion + '%';
      document.getElementById('stat-promedio-grupo').textContent = promedioGrupo;
    }

    document.getElementById('calif-grupo-view').addEventListener('change', function() { renderTablaCalificaciones(); actualizarEstadisticasCalificaciones(); });

    document.getElementById('lista-grupo-select').addEventListener('change', renderListaPreview);

    function editarCalificacion(calificacionId) {
      const calif = allData.find(d => d.__backendId === calificacionId);
      if (!calif) return;
      document.getElementById('calif-grupo').value = calif.grupo_id;
      document.getElementById('calif-grupo').dispatchEvent(new Event('change'));
      setTimeout(() => {
        document.getElementById('calif-alumno').value = calif.alumno_id; document.getElementById('calif-parcial1').value = calif.parcial_1; document.getElementById('calif-parcial2').value = calif.parcial_2; document.getElementById('calif-parcial3').value = calif.parcial_3; document.getElementById('calif-parcial4').value = calif.parcial_4; document.getElementById('calif-parcial1').focus();
      }, 100);
    }

    // Exportaciones PDF y Excel
    function descargarListaExcel() {
      const grupoId = document.getElementById('lista-grupo-select').value; if (!grupoId) return;
      const grupo = allData.find(d => d.__backendId === grupoId); const alumnos = getAlumnosByGrupo(grupoId);
      const dataParaExcel = alumnos.map((a, i) => ({ 'No.': i + 1, 'Nombre del Alumno': a.nombre_completo, 'No. de Control': a.numero_control, 'Carrera': a.carrera, 'Modalidad': a.modalidad, 'Tel√©fono': a.telefono || 'N/A' }));
      const wb = XLSX.utils.book_new(); const ws = XLSX.utils.json_to_sheet(dataParaExcel);
      ws['!cols'] = [ { wch: 5 }, { wch: 35 }, { wch: 15 }, { wch: 25 }, { wch: 15 }, { wch: 15 } ];
      XLSX.utils.book_append_sheet(wb, ws, "Lista de Alumnos");
      XLSX.writeFile(wb, `Lista_${grupo.grupo_nombre.replace(/\s+/g, '_')}.xlsx`); showToast('Excel descargado correctamente');
    }

    function dibujarEncabezadoTecNM(doc) {
      doc.setFont('helvetica', 'bold'); doc.setFontSize(16); doc.setTextColor(COLOR_AZUL_TECNM[0], COLOR_AZUL_TECNM[1], COLOR_AZUL_TECNM[2]); doc.text("TECNOL√ìGICO NACIONAL DE M√âXICO", 105, 20, { align: 'center' });
      doc.setFontSize(14); doc.text("Campus Comit√°n", 105, 28, { align: 'center' });
      doc.setFont('helvetica', 'normal'); doc.setFontSize(12); doc.setTextColor(100); doc.text("Centro de Idiomas", 105, 36, { align: 'center' });
    }

    function descargarListaPDF() {
      const grupoId = document.getElementById('lista-grupo-select').value; if (!grupoId) return;
      const grupo = allData.find(d => d.__backendId === grupoId); const alumnos = getAlumnosByGrupo(grupoId); const maestro = allData.find(d => d.__backendId === grupo?.maestro_id);
      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      dibujarEncabezadoTecNM(doc);
      doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.setTextColor(0); doc.text("Lista Oficial de Alumnos", 14, 50);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(10); doc.text(`Grupo: ${grupo.grupo_nombre} | M√≥dulo: ${grupo.modulo}`, 14, 57); doc.text(`Periodo: ${grupo.periodo || 'N/A'} | Maestro: ${maestro ? maestro.maestro_nombre : 'Sin asignar'}`, 14, 63);
      doc.autoTable({ startY: 70, head: [['#', 'Nombre Completo', 'No. Control', 'Carrera', 'Modalidad']], body: alumnos.map((a, i) => [i + 1, a.nombre_completo, a.numero_control, a.carrera, a.modalidad]), theme: 'grid', headStyles: { fillColor: COLOR_AZUL_TECNM, textColor: 255 }, styles: { fontSize: 9, cellPadding: 3 } });
      doc.save(`Lista_${grupo.grupo_nombre.replace(/\s+/g, '_')}.pdf`); showToast('PDF descargado correctamente');
    }

    function descargarBoletaPDFReal(origen = 'activo') {
      let grupoId = origen === 'activo' ? document.getElementById('boleta-grupo-select').value : document.getElementById('historial-grupo-select').value;
      if (!grupoId) { showToast('Por favor selecciona un grupo', 'error'); return; }

      const grupo = allData.find(d => d.__backendId === grupoId);
      const calificaciones = getCalificacionesByGrupo(grupoId);
      const maestro = allData.find(d => d.__backendId === grupo?.maestro_id);

      const { jsPDF } = window.jspdf; const doc = new jsPDF();
      dibujarEncabezadoTecNM(doc);

      doc.setFont('helvetica', 'bold'); doc.setFontSize(12); doc.setTextColor(0); doc.text("Boleta de Calificaciones Oficial", 14, 50);
      doc.setFont('helvetica', 'normal'); doc.setFontSize(10); doc.text(`Grupo: ${grupo.grupo_nombre} | M√≥dulo: ${grupo.modulo}`, 14, 57); doc.text(`Periodo: ${grupo.periodo || 'N/A'} | Maestro: ${maestro ? maestro.maestro_nombre : 'Sin asignar'}`, 14, 63);

      let aprobados = 0, reprobados = 0, sumaPromedios = 0;

      const bodyData = calificaciones.map((calif, idx) => {
        const p1 = calif?.parcial_1 ?? '-'; const p2 = calif?.parcial_2 ?? '-'; const p3 = calif?.parcial_3 ?? '-'; const p4 = calif?.parcial_4 ?? '-'; const prom = calif?.promedio ?? '-'; const est = calif?.estado ?? 'SIN CALIFICAR';
        if (est === 'APROBADO') aprobados++; if (est === 'REPROBADO') reprobados++; if (prom !== '-') sumaPromedios += parseFloat(prom);
        return [idx + 1, calif.nombre_completo, p1, p2, p3, p4, prom, est];
      });

      doc.autoTable({
        startY: 70, head: [['#', 'Nombre Completo', 'P1', 'P2', 'P3', 'P4', 'Promedio', 'Estado']], body: bodyData, theme: 'grid', headStyles: { fillColor: COLOR_AZUL_TECNM, textColor: 255 }, styles: { fontSize: 9, cellPadding: 2, halign: 'center' }, columnStyles: { 1: { halign: 'left' } },
        didParseCell: function(data) {
           if (data.section === 'body' && data.column.index === 7) {
             if (data.cell.raw === 'APROBADO') data.cell.styles.textColor = [0, 128, 0];
             if (data.cell.raw === 'REPROBADO') data.cell.styles.textColor = [255, 0, 0];
           }
        }
      });

      const finalY = doc.lastAutoTable.finalY + 15;
      doc.setFont('helvetica', 'bold'); doc.text("Estad√≠sticas del Grupo:", 14, finalY);
      doc.setFont('helvetica', 'normal');
      const idxAprob = calificaciones.length > 0 ? ((aprobados / calificaciones.length) * 100).toFixed(1) : 0;
      const idxReprob = calificaciones.length > 0 ? ((reprobados / calificaciones.length) * 100).toFixed(1) : 0;
      const promGen = calificaciones.length > 0 ? (sumaPromedios / calificaciones.length).toFixed(2) : 0;

      doc.text(`Total de alumnos: ${calificaciones.length}`, 14, finalY + 8); doc.text(`Aprobados: ${aprobados} (${idxAprob}%)`, 14, finalY + 14); doc.text(`Reprobados: ${reprobados} (${idxReprob}%)`, 14, finalY + 20);
      doc.setFont('helvetica', 'bold'); doc.text(`Promedio General: ${promGen}`, 120, finalY + 14);

      doc.save(`Boleta_${grupo.grupo_nombre.replace(/\s+/g, '_')}.pdf`); showToast('Boleta PDF descargada correctamente');
    }

  </script>
 </body>
</html>
